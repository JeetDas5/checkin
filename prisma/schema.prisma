// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN // Presidents or Vice presidents
  ADMIN // Domain Leads
  USER // Domain Members
}

enum EventStatus {
  OPEN
  CLOSED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  EXCUSED
  NOT_APPLICABLE
}

model Domain {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users  User[]
  events Event[]
}

model User {
  id            String  @id @default(cuid())
  name          String
  email         String  @unique
  personalEmail String  @unique
  password      String
  roll          String  @unique
  role          Role    @default(USER)
  profile_pic   String?

  // Admin/User belongs to a domain (Super-admin can be null)
  domainId String?
  domain   Domain? @relation(fields: [domainId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  createdEvents     Event[]      @relation("EventCreatedBy")
  attendanceRecords Attendance[] @relation("AttendanceUser")
  markedAttendance  Attendance[] @relation("AttendanceMarkedBy")
}

model Event {
  id    String @id @default(cuid())
  title String

  // domainId null => GBM (optional feature)
  domainId String?
  domain   Domain? @relation(fields: [domainId], references: [id], onDelete: SetNull)

  date DateTime

  // startTime DateTime
  // endTime   DateTime

  status EventStatus @default(OPEN)

  createdById String
  createdBy   User   @relation("EventCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attendance Attendance[]
}

model Attendance {
  id String @id @default(cuid())

  eventId String
  event   Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation("AttendanceUser", fields: [userId], references: [id], onDelete: Cascade)

  status AttendanceStatus @default(ABSENT)

  // Who marked it (admin/superadmin)
  markedById String?
  markedBy   User?   @relation("AttendanceMarkedBy", fields: [markedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, userId]) // ensures one row per user per event
  @@index([eventId])
  @@index([userId])
}

model Otp {
  id        String   @id @default(cuid())
  email     String
  otp       String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([otp])
}
